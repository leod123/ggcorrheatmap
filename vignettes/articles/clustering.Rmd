---
title: "Clustering"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(ggcorrheatmap)
```

Heatmap rows and columns are clustered if the `cluster_rows` and `cluster_cols` arguments are set to `TRUE`. Distance measure and clustering method can be specified with the `cluster_distance` and `cluster_method` arguments, passed on to the `stats::dist()` and `stats::hclust()` functions, respectively.

```{r clustering}
ggcorrhm(mtcars, cluster_rows = TRUE, cluster_cols = TRUE)
```

The `cluster_rows` and `cluster_cols` arguments can also be `hclust` objects if more control is required.

# Dendrogram position

The positions of the dendrograms can be changed with the `dend_rows_side` (`left` or `right`) and `dend_cols_side` (`top` or `bottom`) arguments. For triangular layouts (for symmetric matrices) the dendrograms are placed on the non-empty sides of the heatmap.

```{r, fig.show='hold', out.width='50%'}
# The dendrogram sides can be adjusted with the 'dend_rows_side' and 'dend_cols_side' arguments
ggcorrhm(mtcars, cluster_rows = TRUE, cluster_cols = TRUE,
         dend_rows_side = "left", dend_cols_side = "top")

# Dendrograms can be hidden by setting 'dend_rows' and/or 'dend_cols' to FALSE
ggcorrhm(mtcars, cluster_rows = TRUE, cluster_cols = TRUE, layout = "bl",
         dend_rows_side = "right", dend_cols = FALSE)
```

If annotation and a dendrogram are on the same side, the dendrogram is moved to make place for the annotation.

```{r, fig.height=5, fig.width=7}
annot <- data.frame(.names = colnames(mtcars), a = 1:11)
ggcorrhm(mtcars, cluster_rows = TRUE, cluster_cols = TRUE,
         annot_rows_df = annot, annot_cols_df = annot,
         dend_rows_side = "left")
```

# Changing how the dendrograms look

The `dend_col`, `dend_height`, `dend_lwd`, and `dend_lty` arguments change the colour, height (scaling), linewidth, and linetype of the dendrograms, respectively. 

```{r}
ggcorrhm(mtcars, cluster_rows = TRUE, cluster_cols = TRUE,
         dend_col = "cyan", dend_height = 2, dend_lwd = 1, dend_lty = 2)
```

To apply these changes to only the row or only the column dendrograms, use the `dend_rows_params` and `dend_cols_params` arguments. These arguments take a named list containing one or more of `col`, `height`, `lwd`, and `lty`.

```{r}
ggcorrhm(mtcars, cluster_rows = TRUE, cluster_cols = TRUE,
         dend_rows_params = list(col = "cyan", height = 2),
         dend_cols_params = list(lwd = 1, lty = 2))
```

# More customisation using `dendextend`

Finer customisation of dendrograms can be done with the `dend_rows_extend` and `dend_cols_extend` arguments. These use the `dendextend` package to change the dendrogram appearance. The input can be either a named list of lists, where each element is named after the `dendextend` function to use and contains a list of the arguments to pass, or a functional sequence (`fseq` object) that strings together the functions to use.

```{r}
# List method
ggcorrhm(mtcars, cluster_rows = TRUE, cluster_cols = TRUE, dend_height = 1,
         # Multiple elements can use the same function as lists don't require unique names
         dend_rows_extend = list(
           set = list("branches_k_col", k = 3),
           set = list("branches_lty", c(1, 2, 3))
         ),
         # NULL or empty list if no arguments are to be passed
         dend_cols_extend = list(
           highlight_branches_lwd = list(values = seq(1, 4)),
           highlight_branches_col = list()
         ))
# The equivalent call using the fseq method
# library(dplyr)
# library(dendextend)
# ggcorrhm(mtcars, cluster_rows = TRUE, cluster_cols = TRUE,
#          dend_rows_extend = . %>%
#            set("branches_k_col", k = 3) %>%
#            set("branches_lty", c(1, 2, 3)),
#          dend_cols_extend = . %>%
#            highlight_branches_lwd(values = seq(1, 4)) %>%
#            highlight_branches_col())
```

Using the `dend_*_extend` arguments also makes it possible to display the nodes of the dendrograms.

```{r}
# Get clustered labels
clust <- hclust(dist(cor(mtcars)))
clust_lab <- clust$labels[clust$order]

ggcorrhm(mtcars, cluster_rows = TRUE, cluster_cols = TRUE, dend_height = 1,
         # Multiple elements can use the same function as lists don't require unique names
         dend_rows_extend = list(
           # More on customising segments
           # Can specify branches to affect by labels using the 'by_labels_branches_*' options
           set = list("by_labels_branches_col", value = clust_lab[1:5], TF_values = "red"),
           set = list("by_labels_branches_lty", value = c("drat", "vs"), TF_values = 3),
           set = list("by_labels_branches_lwd", value = clust_lab[6:11], TF_values = 1),
           # Node and leaf options
           # Specify nodes before leaves so the leaf options are not overwritten
           # dendextend requires pch to be specified for any nodes to be drawn
           # Here, setting colour or scaling for nodes also draws them even without pch specification
           # set = list("nodes_pch", 19),
           set = list("nodes_cex", 2),
           set = list("nodes_col", "orange"),
           set = list("leaves_pch", 21),
           set = list("leaves_cex", 3),
           set = list("leaves_col", "purple")
         ),
         # NULL or empty list if no arguments are to be passed
         dend_cols_extend = list(
           highlight_branches_col = NULL,
           # Node options
           set = list("nodes_pch", c(15, 16, 17)),
           set = list("nodes_cex", 2:4),
           # If passing numbers for the colours, make sure they are characters
           set = list("nodes_col", as.character(1:5))
         ))
```


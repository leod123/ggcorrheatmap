---
title: "Correlation heatmaps"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, results='hide', message=FALSE, warning=FALSE}
library(ggcorrheatmap)
library(ggplot2)
library(dplyr)
```

Correlation heatmaps can be made easily using the `ggcorrhm()` function. `ggcorrhm()` is a wrapper for (and shares most of its arguments with) `gghm()` and calculates the correlation matrix for the input passed to `gghm()`. If one matrix is provided the column-column correlations are plotted. If two matrices are provided, the correlations between the columns in the two matrices are plotted. Using the `cor_method` and `cor_use` different `method` and `use` arguments can be passed to `stats::cor`.

```{r symmetric correlation heatmap, fig.alt='A heatmap depicting the correlation matrix of the columns in the mtcars dataset. The colour scale goes from -1 to 1 with colours ranging from blue (skyblue2) to white to red (sienna2).'}
ggcorrhm(mtcars)
```

```{r asymmetric correlation heatmap, fig.height=3, fig.width=8, fig.alt='A heatmap showing the correlation between the columns in the iris data (on the rows) and the columns in mtcars (on the columns).'}
ggcorrhm(iris[1:nrow(mtcars), -5], mtcars)
```

# Changing the colours

`ggcorrhm()` sets the fill scale to use `ggplot2::scale_fill_gradient2()` with limits set to [-1, 1]. The colours can be changed using the `high`, `mid` and `low` arguments. If a discrete scale is desired, `bins` can be used to bin the scale. The scale can be overwritten completely by adding a `ggplot2` scale to the plot.

For symmetric matrices, the axis names are drawn on the diagonal. The `names_diag`, `names_x` and `names_y` arguments control where names should be drawn.

```{r changing colour, out.width='50%', fig.show='hold', fig.alt='Two heatmaps of the mtcars correlation matrix. The colour scale of the first one is changed to consist of 6 bins and the colours go from magenta to yellow to green. The second one uses the default ggplot2 continuous scale (dark blue to light blue)'}
ggcorrhm(mtcars, names_diag = FALSE, names_x = TRUE, names_y = TRUE,
         high = "green", low = "magenta", mid = "yellow", bins = 6)

ggcorrhm(mtcars) + scale_fill_continuous()
```

# Changing the layout

For symmetric heatmaps, the `layout` argument can be used to get triangular layouts. The possible layouts are full matrix, top left, top right, bottom left, and bottom right.

```{r heatmap layouts, fig.alt='Two heatmap of the mtcars correlation matrix. The first plot shows only the top left triangle including the diagonal with names written on it (diagonal running bottom left to top right and row labels reversed compared to the previous heatmaps). The second figure has only the bottom right triangle, but without the diagonal (names are written where the diagonal would be).'}
ggcorrhm(mtcars, layout = "topleft")
# The diagonal is displayed by default but can be hidden using the `include_diag` argument
# Layouts can be specified by the first letters e.g. br, tl, f (for full), w (whole, same as full)
ggcorrhm(mtcars, layout = "br", include_diag = FALSE)
```

# Label customisation

The looks of the names displayed in the diagonal of symmetric matrices can be adjusted with the `names_diag_params` argument, which takes a named list of parameters to pass to `ggplot2::geom_text()`. For names displayed on the x and y axes, use `ggplot2::theme()` on the generated plot object to change the appearance.

```{r, fig.width=5, fig.height=4, fig.show='hold', out.width='50%', fig.alt='Two mtcars correlation heatmaps with the bottom left and bottom right triangles and no diagonals. In the first plot, the names on the diagonal are at a 45 degree angle and the text is magenta-coloured. The second plot has the names angled 45 degrees in the other direction apart from the names at the top and bottom which is angled at 90 and 0 degrees, respectively. The text colour is picked randomly from red, green, and blue.'}
ggcorrhm(mtcars, layout = "bl", show_legend = FALSE, include_diag = FALSE,
         names_diag_param = list(
           angle = 45, vjust = 0.5, hjust = 0.5, colour = "magenta"
         ))
# Also take vectorised input
set.seed(123)
ggcorrhm(mtcars, layout = "br", include_diag = FALSE,
         names_diag_param = list(
           angle = c(0, rep(-45, 9), 90),
           hjust = c(rep(0.7, 10), 0.3),
           colour = sample(c("red", "green", "blue"), 11, TRUE)
         ))
```

# Legend position

The legend can be moved around by adding to the theme of the output plot using `ggplot2::theme()`. Use the `legend.position.inside` argument to move the legend to the plotting area to make use of the empty space of triangular layouts.

```{r legend position, fig.width=5, fig.height=4, fig.show='hold', out.width='50%', fig.alt='Two mtcars correlation heatmaps. In the first one the legend has been moved above the heatmap and is horizontal. In the second the bottom right triangle is drawn and the legend is placed in the empty space where the top left triangle would be drawn.'}
ggcorrhm(mtcars) + theme(legend.position = "top", legend.title = element_text(vjust = 0.8))
ggcorrhm(mtcars, layout = "br") +
  theme(legend.position = "inside", legend.position.inside = c(0.2, 0.7))
```

# Clustering and annotation

Just like with `gghm()`, the heatmap can be clustered and annotated. Triangular layouts limit the positions of annotation and dendrograms to the non-empty sides of the heatmap.

```{r clustering and annotation, fig.alt='A top left triangle correlation heatmap of mtcars. The rows and columns have been clustered and a dendrogram is drawn above the heatmap. On the left side are two thinner columns containing continuous and categorical annotation.'}
set.seed(123)
# Make a correlation heatmap with a triangular layout, annotations and clustering
row_annot <- data.frame(.names = colnames(mtcars),
                        annot1 = sample(letters[1:3], ncol(mtcars), TRUE),
                        annot2 = rnorm(ncol(mtcars)))
ggcorrhm(mtcars, layout = "tl", cluster_rows = TRUE, cluster_cols = TRUE,
         dend_rows = FALSE, annot_rows_df = row_annot, annot_rows_label_side = "top")
```

# Cell text

The `cell_labels` argument labels cells with their values. The `cell_label_col`, `cell_label_size` and `cell_label_digits` arguments control the text colour, size and the number of displayed digits, respectively.

```{r cell labels, fig.show='hold', out.width='50%', fig.alt='Two mtcars bottom right correlation heatmaps. Both have text in the cells showing the correlation values on top of the colours that scale with the values. The tet in the first one is black and has two digits. The text in the second one is white, has one digit and the size varies randomly.'}
ggcorrhm(mtcars, layout = "br", cell_labels = TRUE)
set.seed(123)
ggcorrhm(mtcars, layout = "br", cell_labels = TRUE,
         cell_label_digits = 1,
         # cell_label_col and cell_label_size take one value or
         # one for each cell being labelled (not counting names on the diagonal)
         cell_label_col = "white",
         cell_label_size = sample(2:4, 55, TRUE))
```

# Cell shape

Correlation heatmaps are sometimes plotted with circles. Using the `mode` argument allows for custom cell shapes. The shape size is set to scale with the absolute value of the correlation. `size_scale` can be provided to overwrite this behaviour. Setting `mode` to 'text' writes the values in empty cells, with the text colour scaling with the value.

```{r cell shape, fig.show='hold', out.width='50%', fig.alt='Two mtcars correlation heatmaps. The first one has circles instead of cells. The colour scales with the correlation and the size with the absolute value of the correlation. The second plot has squares (diamonds) and a major grid is added in the background.'}
# If mode is a number, the R pch symbols are used, meaning 21 produces circles.
ggcorrhm(mtcars, mode = 21) + labs(title = "mode = 21")
# It is also possible to use shapes other than circles. Only 21-25 support filling.
# Change the size range using the size_range argument
ggcorrhm(mtcars, mode = 23, size_range = c(2, 7)) +
  # Can add a grid in the background with ggplot2::theme()
  theme(panel.grid.major = element_line()) +
  labs(title = "mode = 23")
```

It's also possible to draw mixed layouts by providing two values to `layout` and `mode`. See the [mixed layouts](mixed.html) vignette for more details.

```{r, fig.alt='mtcars heatmap where the top right triangle (and the diagonal) has filled cells and the bottom left triangle has cells containing text instead. The text shows the correlation values and the colour scales with the correlation like the cells in the other triangle.'}
# Default modes for mixed layouts is 'heatmap' and 'text'
ggcorrhm(mtcars, layout = c("tr", "bl"))
```

# P-values

P-values can be calculated by setting the `p_values` argument to `TRUE`. The values can be adjusted for multiple testing by passing a string specifying the adjustment method to `p_adjust`. If the correlation matrix is symmetric, the diagonal is excluded and only half of the off-diagonal values are used for the adjustment. The calculated p-values will be included in the data if `return_data` is `TRUE`.

By default, cells are marked with asterisks if `p_values` is `TRUE`. The `p_thresholds` argument controls the p-value thresholds. `p_thresholds` must be a named numeric vector where the values specify the thresholds (in ascending order) and the names are the symbols to use when an adjusted p-value is below each threshold. `stats::symnum()` is used to convert p-values and the last value of `p_thresholds` must be 1 (or any higher number) to set the upper bound. By default, `p_thresholds` is set to be `c("***" = 0.001, "**" = 0.01, "*" = 0.05", 1)`. As can be seen, 1 is left unnamed so that any p-values between 0.05 and 1 are unmarked.

If `cell_labels` is `TRUE` (so that correlation values are written in the cells), the symbols from `p_thresholds` are added at the end of the correlation values. It is also possible to write out the p-values instead of correlation values by setting both `cell_labels` and `cell_label_p` to `TRUE`.

```{r, fig.alt="Three mtcars correlation heatmaps. The cells are coloured by correlation and contain text that depends on the p-values of the correlation coefficients. In the first one cells are marked with up to three asterisks. In the second plot cells have the correlation values written and up to three asterisks are added on after the correlation values. The third figure instead has a mix of cells with a plus symbol, an asterisk, and 'ns' written in them."}
# P-value symbols added to the plot
ggcorrhm(mtcars, p_values = TRUE, p_adjust = "bonferroni", cell_label_size = 6)
# With correlation text
ggcorrhm(mtcars, p_values = TRUE, p_adjust = "bonferroni", cell_labels = TRUE)
# Changing the symbols
ggcorrhm(mtcars, p_values = TRUE, p_adjust = "bonferroni",
         p_thresholds = c("+" = 0.01, "*" = 0.05, "ns" = 1))
```

By returning the data and using `ggplot2` functions it is possible to be more creative with the p-value marking than `ggcorrhm` allows out of the box.

```{r, fig.alt='mtcars correlation heatmap showing the bottom right triangle. Some cells are marked with asterisks whose sizes scale with -log10 of the adjusted p-values. Those cells also have thick grey border. Other cells have thin, dotted borders.'}
p <- ggcorrhm(mtcars, p_values = TRUE, p_thresholds = NULL,
              p_adjust = "bonferroni", return_data = TRUE,
              layout = "br", include_diag = FALSE)
p$plot_data <- mutate(p$plot_data,
                      p_lty = case_when(p_adj < 0.05 ~ 1, TRUE ~ 3),
                      p_lwd = case_when(p_adj < 0.05 ~ 1, TRUE ~ 0.5),
                      p_size = -log10(p_adj))
ggcorrhm(mtcars, border_lty = p$plot_data$p_lty, border_lwd = p$plot_data$p_lwd,
         layout = "br", include_diag = FALSE) +
  geom_point(aes(size = p_size), data = p$plot_data %>%
               filter(p_adj < 0.05, as.character(row) != as.character(col)),
             shape = "*") +
  scale_size(range = c(4, 8)) +
  labs(size = "-log10(p_adj)")
```

```{r, fig.alt='A top left correlation heatmap of mtcars. Some cells are marked with a large x (indicating that the adjusted p-value is above 0.05).'}
p <- ggcorrhm(mtcars, p_values = TRUE, p_thresholds = NULL,
              p_adjust = "bonferroni", return_data = TRUE,
              layout = "tl", include_diag = FALSE)
ggcorrhm(mtcars, layout = "tl", include_diag = FALSE) +
  geom_point(data = p$plot_data %>%
               # Mark cells above a threshold
               filter(p_adj >= 0.05, as.character(row) != as.character(col)),
             shape = 4, size = 8)
```


# Other packages

A benefit of making the plot with `ggplot2` is the possibility of modifying and arranging the plot using `ggplot2` and its many extensions. `ggcorrheatmap` is convenient for making simple correlation heatmaps, with options for extensive customisation of the appearance and layout, and built-in support for clustering (with dendrograms) and annotation. Another package for making correlation heatmaps with `ggplot2` is `ggcorrplot` which is faster and has more ways of visualising p-values. If having the plot made with `ggplot2` is not necessary, the `corrplot` package can make flexible correlation plots with many alternative visualisations.

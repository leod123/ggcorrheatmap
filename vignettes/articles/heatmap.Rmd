---
title: "Making a heatmap"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The `gghm` function can be used to make a heatmap from a matrix of data frame. Rows and columns are ordered the same way as in the input.

```{r setup}
library(ggcorrheatmap)
library(ggplot2)

gghm(mtcars)
```

The `ggcorrhm` function uses `gghm` to build a correlation heatmap. The correlations between the columns in the input are computed and plotted.

If the matrix being plotted is symmetric (as such a correlation matrix is), the axis labels are drawn on the diagonal. This behaviour can be changed using the `names_diag`, `names_x` and `names_y` arguments. A symmetric heatmap can also be plotted using triangular layouts, explained more in the [correlation matrix](correlation.html) vignette.

```{r correlation heatmap}
ggcorrhm(mtcars)
```

# Specifying colours

The colours of the heatmap can be adjusted by passing a `ggplot2::scale_fill_*` function call to the `fill_scale` argument.

```{r}
gghm(mtcars, fill_scale = scale_fill_viridis_c())

# Heatmap with discrete values
# Border colour and linewidth can be changed using the `border_col` and `border_lwd` arguments
set.seed(123)
gghm(replicate(15, sample(letters[1:3], 15, TRUE)),
     fill_scale = scale_fill_brewer(palette = "Pastel2"),
     border_col = "thistle1", border_lwd = 1)
```

Cell borders are by default grey, but can be removed by setting `border_col` or `border_lwd` to NA (if `cell_shape` is non-numeric, explained more in [correlation heatmaps](correlation.html)) or `border_lwd` to 0 (if `cell_shape` is numeric).

```{r}
gghm(volcano, fill_scale = scale_fill_viridis_c(), border_col = NA,
     names_x = FALSE, names_y = FALSE)
```

# Handling NAs

NAs in the data can be removed or set to a specific colour using the `na_remove` argument or the `fill_scale`argument, respectively.

```{r, fig.width=4, fig.height=5, fig.show='hold', out.width='33%'}
# Introduce NAs
df_na <- as.matrix(mtcars)
set.seed(123)
df_na[sample(length(df_na), 100)] <- NA

# With NAs and the default colour
gghm(df_na, show_legend = FALSE) + labs(title = "With NAs")
# Colour NAs using scale function
gghm(df_na, show_legend = FALSE,
     fill_scale = scale_fill_continuous(na.value = "magenta")) +
  labs(title = "Change NA colour")
# Remove NAs, removes the border as well
gghm(df_na, show_legend = FALSE, na_remove = TRUE) + labs(title = "NAs removed")
```

# Clustering and annotation

Clustering can be applied to the rows and columns using the `cluster_rows` and `cluster_cols` arguments. See the [clustering](cluster.html) vignette for more on clustering.

```{r clustering}
gghm(scale(mtcars), cluster_rows = TRUE, cluster_cols = TRUE)
```

Row and column annotation is added by providing data frames to the `annot_rows_df` and `annot_cols_df` arguments. More details on annotation can be found in the [annotation](annotation.html) vignette.

```{r annotation}
row_annot <- data.frame(.names = rownames(mtcars),
                        a = sample(letters[1:4], nrow(mtcars), TRUE))

gghm(mtcars, annot_rows_df = row_annot)
```

Clustering and annotation can of course be added simultaneously.

```{r}
gghm(scale(mtcars), cluster_rows = TRUE, annot_rows_df = row_annot)
```

# External customisation

The plotting data can be returned by setting the `return_data` argument to `TRUE`, allowing for further customisation of e.g. cell labels.

```{r, fig.show='hold', out.width='50%', fig.width=4, fig.height=5}
plot_list <- gghm(scale(mtcars[, 1:10]), return_data = TRUE, border_col = NA,
                  fill_scale = scale_fill_gradient2(low = "deepskyblue", mid = "white", high = "salmon"))

# Add own labels
plot_list$plot_data$lab <- sample(letters[1:6], nrow(plot_list$plot_data), TRUE)

plot_list$plot +
  geom_text(aes(label = lab), plot_list$plot_data, size = 3)

# Or maybe points
plot_list$plot_data$lab <- ifelse(plot_list$plot_data$value > 1 |
                                  plot_list$plot_data$value < -1, "*", NA)
plot_list$plot +
  geom_point(data = subset(plot_list$plot_data, !is.na(lab)), shape = "*", size = 4)
```

There are many arguments, allowing for quite some flexibility in the heatmap layout. Most of the arguments are showcased in the vignettes, hopefully they can be of some help.

```{r}
set.seed(123)
annot_df <- cbind(data.frame(.names = colnames(mtcars)), 
                  replicate(10, sample(letters[1:3], ncol(mtcars), TRUE)))
row_annot_params <- list(dist = -10, gap = 2, size = 0.1, border_lwd = 0.5, border_col = "blue")
col_annot_params <- list(dist = 0, gap = -0.5, size = 1, border_lwd = 0.5, border_col = "brown")
row_label_params <- list(gp = grid::gpar(cex = 2, col = "yellow"))
col_label_params <- list(rot = 180, hjust = 0)
diag_params <- list(angle = seq(0, 360, length.out = ncol(mtcars)),
                    colour = sample(c("red", "green", "blue"), ncol(mtcars), TRUE))
row_dend_param <- list(height = 1)
row_dend_extend <- list(set = list("branches_k_color", k = 3),
                        highlight_branches_lwd = NULL)
col_dend_extend <- list(highlight_branches_col = NULL,
                        set = list("branches_lty", 1:3),
                        set = list("branches_lwd", 2))

gghm(cor(mtcars), fill_scale = scale_fill_steps2(high = "magenta", mid = "orange", low = "cyan"),
     label_cells = TRUE, cell_label_digits = 2, cell_label_size = 3,
     annot_rows_df = annot_df[, 1:6], annot_cols_df = annot_df[, c(1, 7:11)],
     annot_rows_params = row_annot_params, annot_cols_params = col_annot_params,
     annot_rows_label_params = row_label_params, annot_cols_label_params = col_label_params,
     annot_rows_label_side = "top", layout = "br", cluster_rows = TRUE, cluster_cols = TRUE,
     names_diag_param = diag_params, names_x = TRUE, names_y = TRUE,
     dend_rows_params = row_dend_param, dend_rows_extend = row_dend_extend,
     dend_cols_extend = col_dend_extend)
```

```{r}
library(dplyr)
library(dendextend)
set.seed(123)
annot <- cbind(data.frame(colnames(mtcars)),
               as.data.frame(replicate(5, {
                   sample(letters[1:3], ncol(mtcars), T)
               })),
               as.data.frame(replicate(5, {
                   rnorm(ncol(mtcars))
               }))) %>% `colnames<-`(c(".names", paste0("V", 1:10)))
ggcorrhm(mtcars, cluster_rows = T, cluster_cols = T,
         high = "orange", mid = "green", low = "blue",
         names_x = T, names_y = T,
         names_diag_param = list(angle = seq(0, 360, length.out = 11),
                                 colour = c("black", "red", "green", "white", "yellow", "blue", "salmon", "purple", "cyan", "gold", "grey"),
                                 size = runif(11, 2, 5)),
         border_col = "beige",
         dend_rows_side = "left",
         annot_rows_df = annot[, seq(1, 11, by = 2)],
         annot_cols_df = annot[, c(1, seq(2, 6, by = 2))],
         annot_rows_params = list(dist = -3, gap = 1.5, size = 0.5, border_col = "magenta"),
         annot_cols_params = list(gap = 0.5, size = 2, border_col = "yellow", border_lwd = .7),
         dend_height = 1, annot_rows_label_side = "top",
         dend_rows_extend = list(
             set = list("nodes_pch", 21),
             set = list("nodes_col", "red"),
             set = list("nodes_cex", 2),
             set = list("leaves_pch", 19),
             set = list("leaves_col", "brown"),
             set = list("leaves_cex", 3),
             highlight_branches_col = list(),
             highlight_branches_lwd = list(c(.5, 1, 2, 3))
         ),
         dend_cols_extend = list(
             set = list("by_labels_branches_col", value = c("hp", "disp"), TF_values = "purple", type = "any"),
             set = list("by_labels_branches_lwd", value = c("wt", "vs", "am")),
             set = list("by_labels_branches_lty", value = c("am", "drat", "disp"), TF_values = 2, type = "any"),
             set = list("by_labels_branches_col", value = "wt", TF_values = "orange"),
             set = list("nodes_pch", c(1:6)),
             set = list("nodes_cex", seq(.5, 3, by = .6))
         ),
         annot_rows_label_params = list(rot = 180, gp = grid::gpar(col = "yellow", cex = 2)),
         annot_cols_label_params = list(rot = -90, gp = grid::gpar(col = "blue", cex = 1.5)))
```

